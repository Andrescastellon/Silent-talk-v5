<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Traductor LSC - WebApp</title>

<style>
:root {
  --primary: #4e73df;
  --secondary: #1cc88a;
  --danger: #e74a3b;
  --bg: linear-gradient(180deg, #f8f9fc 0%, #e2e6ea 100%);
  --card-bg: #fff;
  --radius: 12px;
  --shadow: 0 4px 12px rgba(0,0,0,0.08);
  --text: #333;
  --muted: #6c757d;
}
body {
  font-family: "Poppins", "Segoe UI", Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  margin: 0;
  padding: 0;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
}
header {
  width: 100%;
  background: var(--primary);
  color: #fff;
  padding: 16px;
  box-shadow: var(--shadow);
  text-align: center;
}
header h2 { margin: 0; font-size: 1.4rem; letter-spacing: 0.5px; }

main {
  max-width: 600px;
  width: 94%;
  background: var(--card-bg);
  margin-top: 18px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 16px;
}

video, canvas {
  width: 100%;
  max-height: 360px;
  background: #000;
  border-radius: var(--radius);
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}

.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 12px;
  justify-content: center;
}
select, button {
  padding: 10px 14px;
  border-radius: var(--radius);
  border: 1px solid #ccc;
  font-size: 15px;
  background: #fff;
  transition: 0.25s;
}
select:focus, button:focus { outline: none; border-color: var(--primary); }
button {
  cursor: pointer;
  color: #fff;
  border: none;
  font-weight: 500;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
button:hover { opacity: 0.9; transform: translateY(-1px); }

#startCam { background: var(--secondary); }
#captureSample { background: var(--secondary); }
#trainBtn { background: var(--primary); }
#predictBtn { background: #17a2b8; }
#saveModelBtn { background: #f6c23e; color: #333; }
#loadModelBtn { background: #36b9cc; }
#clearDataBtn { background: var(--danger); }

.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 14px;
}
.status {
  background: #fafbfc;
  border-radius: var(--radius);
  padding: 12px;
  border: 1px solid #e1e5ea;
  box-shadow: var(--shadow);
}
.status strong { color: var(--primary); }
small { color: var(--muted); font-size: 13px; }

footer {
  margin: 18px 0;
  font-size: 13px;
  color: var(--muted);
  text-align: center;
}
</style>
</head>

<body>
<header>
  <h2>Traductor de Lengua de Se√±as Colombiana</h2>
</header>

<main>
  <video id="video" autoplay playsinline></video>
  <canvas id="capture" style="display:none"></canvas>

  <div class="controls">
    <button id="startCam">üé• Iniciar c√°mara</button>
    <label for="letter">Letra:</label>
    <select id="letter"></select>
    <button id="captureSample" disabled>üì∏ Capturar</button>
    <button id="trainBtn" disabled>üß† Entrenar</button>
    <button id="predictBtn" disabled>ü§ñ Predecir</button>
    <button id="saveModelBtn">üíæ Guardar</button>
    <button id="loadModelBtn">üìÇ Cargar</button>
    <button id="clearDataBtn">üßπ Limpiar</button>
  </div>

  <div class="grid">
    <div class="status">
      <div><strong>Muestras por clase:</strong></div>
      <div id="counts">‚Äî</div>
      <small>Recomendado ‚â•30 por letra</small>
    </div>
    <div class="status">
      <div><strong>Estado:</strong></div>
      <div id="log">Presiona ‚ÄúIniciar c√°mara‚Äù para comenzar</div>
      <small id="progress"></small>
    </div>
  </div>

  <footer>Desarrollado para fines educativos ‚Äî TensorFlow.js + C√°mara trasera</footer>
</main>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>

<script>
/* ----------- Inicializaci√≥n ----------- */
const letters = Array.from(Array(26)).map((_,i)=>String.fromCharCode(65+i));
const selectLetter = document.getElementById('letter');
letters.forEach(l => {
  const opt = document.createElement('option'); opt.value = l; opt.text = l;
  selectLetter.appendChild(opt);
});
const video = document.getElementById('video');
const canvas = document.getElementById('capture');
const ctx = canvas.getContext('2d');
const countsEl = document.getElementById('counts');
const logEl = document.getElementById('log');
const progressEl = document.getElementById('progress');

let samples = {}; letters.forEach(l => samples[l]=[]);
let model = null;
const IMAGE_SIZE = 64, BATCH_SIZE = 24, EPOCHS = 20;
let stream = null;

function log(t){ logEl.innerText = t; }
function updateCounts(){
  countsEl.innerText = letters.map(l => `${l}: ${samples[l].length}`).join(' | ');
}

/* ----------- C√°mara ----------- */
async function startCamera(){
  try {
    if (stream) { log('La c√°mara ya est√° activa.'); return; }
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } },
      audio: false
    });
    video.srcObject = stream;
    await video.play();
    document.getElementById('captureSample').disabled = false;
    document.getElementById('trainBtn').disabled = false;
    document.getElementById('predictBtn').disabled = false;
    log('‚úÖ C√°mara trasera iniciada correctamente');
  } catch (e) {
    log('‚ùå No se pudo acceder a la c√°mara trasera: ' + e.message);
  }
}
document.getElementById('startCam').addEventListener('click', startCamera);

/* ----------- Captura ----------- */
function captureImageTensor(){
  canvas.width = video.videoWidth; canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const side = Math.min(canvas.width, canvas.height);
  const sx = (canvas.width - side)/2, sy = (canvas.height - side)/2;
  const tmp = document.createElement('canvas'); tmp.width = tmp.height = IMAGE_SIZE;
  const tctx = tmp.getContext('2d');
  tctx.drawImage(canvas, sx, sy, side, side, 0, 0, IMAGE_SIZE, IMAGE_SIZE);
  const imgData = tctx.getImageData(0,0,IMAGE_SIZE,IMAGE_SIZE);
  return tf.browser.fromPixels(imgData).toFloat().div(255.0);
}

document.getElementById('captureSample').onclick = () => {
  const label = selectLetter.value;
  samples[label].push(captureImageTensor());
  updateCounts();
  log(`Muestra a√±adida para ${label} (${samples[label].length})`);
};

/* ----------- Borrar muestras ----------- */
document.getElementById('clearDataBtn').onclick = () => {
  if (!confirm('¬øBorrar todas las muestras?')) return;
  letters.forEach(l => { samples[l].forEach(t => t.dispose()); samples[l]=[]; });
  updateCounts(); log('Muestras borradas.');
};

/* ----------- Modelo y entrenamiento ----------- */
function buildModel(numClasses){
  const m = tf.sequential();
  m.add(tf.layers.conv2d({inputShape:[IMAGE_SIZE,IMAGE_SIZE,3],filters:16,kernelSize:3,activation:'relu'}));
  m.add(tf.layers.maxPooling2d({poolSize:2}));
  m.add(tf.layers.conv2d({filters:32,kernelSize:3,activation:'relu'}));
  m.add(tf.layers.maxPooling2d({poolSize:2}));
  m.add(tf.layers.flatten());
  m.add(tf.layers.dropout({rate:0.3}));
  m.add(tf.layers.dense({units:128,activation:'relu'}));
  m.add(tf.layers.dense({units:numClasses,activation:'softmax'}));
  m.compile({optimizer: tf.train.adam(0.0005), loss: 'categoricalCrossentropy', metrics:['accuracy']});
  return m;
}

function prepareDataset(){
  const xs=[], ys=[];
  for (let i=0;i<letters.length;i++){
    for (let t of samples[letters[i]]){
      xs.push(t);
      const label = new Array(letters.length).fill(0);
      label[i]=1; ys.push(label);
    }
  }
  if (!xs.length) return null;
  return { x: tf.stack(xs), y: tf.tensor2d(ys) };
}

document.getElementById('trainBtn').onclick = async ()=>{
  const dataset = prepareDataset();
  if (!dataset){ log('Agrega muestras antes de entrenar.'); return; }
  model = buildModel(letters.length);
  log('Entrenando modelo...');
  await model.fit(dataset.x, dataset.y, {
    epochs: EPOCHS,
    batchSize: Math.min(BATCH_SIZE, Math.max(8, Math.floor(dataset.x.shape[0]/4))),
    validationSplit: 0.12,
    callbacks:{onEpochEnd:(e,l)=>progressEl.innerText=`Epoch ${e+1}/${EPOCHS} ‚Äî acc:${(l.acc||0).toFixed(2)}`}
  });
  log('Entrenamiento completado ‚úÖ');
  dataset.x.dispose(); dataset.y.dispose();
};

/* ----------- Predicci√≥n ----------- */
document.getElementById('predictBtn').onclick = async ()=>{
  if (!model){ log('Entrena o carga un modelo primero.'); return; }
  const t = captureImageTensor(), input = t.expandDims(0);
  const preds = model.predict(input);
  const data = await preds.data();
  const idx = data.indexOf(Math.max(...data));
  const predicted = letters[idx];
  log(`Predicci√≥n: ${predicted} (${(data[idx]*100).toFixed(1)}%)`);
  t.dispose(); input.dispose(); preds.dispose();
};

/* ----------- Guardar / Cargar ----------- */
document.getElementById('saveModelBtn').onclick = async ()=>{
  if (!model){ log('No hay modelo.'); return; }
  await model.save('indexeddb://lsc-model');
  log('Modelo guardado en almacenamiento local üíæ');
};
document.getElementById('loadModelBtn').onclick = async ()=>{
  try {
    model = await tf.loadLayersModel('indexeddb://lsc-model');
    log('Modelo cargado desde almacenamiento local.');
  } catch(e){ log('No se encontr√≥ modelo guardado.'); }
};

/* ----------- Limpieza ----------- */
window.addEventListener('beforeunload', ()=>{
  letters.forEach(l => samples[l].forEach(t => t.dispose()));
  if (model) model.dispose();
  if (stream) stream.getTracks().forEach(t=>t.stop());
});
</script>
</body>
</html>
