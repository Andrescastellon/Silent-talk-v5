<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Traductor LSC - C√°mara trasera</title>
<style>
body{font-family:Arial, sans-serif;background:#f2f2f2;margin:0;padding:0;text-align:center}
#videoEl{width:320px;height:240px;border:1px solid #aaa;margin:10px;background:#000}
button{margin:4px;padding:8px 12px;border:none;background:#1976d2;color:white;border-radius:5px}
#logs{font-size:12px;max-height:100px;overflow-y:auto;background:#fff;padding:5px;border:1px solid #ddd;width:90%;margin:10px auto;text-align:left}
#progress{width:80%;margin:auto}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 20px;border-radius:20px;opacity:0;transition:.4s}
.toast.show{opacity:1}
</style>
</head>
<body>
<h2>Traductor de Lengua de Se√±as Colombiana</h2>

<!-- üîò Bot√≥n para iniciar la c√°mara trasera -->
<button id="startBtn">üé• Iniciar c√°mara trasera</button><br>

<video id="videoEl" autoplay muted playsinline></video><br>

<!-- Botones de control -->
<button id="captureBtn" disabled>Capturar muestra</button>
<button id="trainBtn" disabled>Entrenar</button>
<button id="predictBtn" disabled>Predicci√≥n</button>
<button id="saveModelBtn" disabled>Guardar modelo</button>
<button id="loadModelBtn">Cargar modelo</button>
<button id="exportDataBtn">Exportar dataset</button>
<input type="file" id="importDataInput" accept=".json" hidden>
<button id="importDataBtn">Importar dataset</button>
<div id="progress"></div>
<div id="logs"></div>
<div id="toast" class="toast"></div>

<!-- Librer√≠as necesarias -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

<script>
let samples=[],labels=[],model,lastVector,hands,stream;
const log=t=>{logs.innerHTML+=t+'<br>';logs.scrollTop=logs.scrollHeight;}
const showToast=t=>{toast.textContent=t;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),2500);}

// Inicializa MediaPipe Hands
hands=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
hands.setOptions({maxNumHands:1,modelComplexity:1,minDetectionConfidence:.6,minTrackingConfidence:.6});
hands.onResults(draw);

// üöÄ Iniciar c√°mara trasera
document.getElementById('startBtn').onclick=async()=>{
  try {
    if (stream) { showToast('La c√°mara ya est√° activa'); return; }

    // Intentar c√°mara trasera (environment)
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } }, audio: false
    });
    videoEl.srcObject = stream;
    await videoEl.play();

    // Inicia an√°lisis de frames
    loopFrame();

    document.getElementById('captureBtn').disabled = false;
    document.getElementById('trainBtn').disabled = false;
    document.getElementById('predictBtn').disabled = false;
    showToast('C√°mara trasera iniciada');
    log('C√°mara trasera activa ‚úîÔ∏è');
  } catch (err) {
    console.error(err);
    showToast('No se pudo acceder a la c√°mara trasera. Usando la c√°mara disponible.');
    // Si falla, intentar con la c√°mara por defecto
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: true });
      videoEl.srcObject = stream;
      await videoEl.play();
      loopFrame();
      document.getElementById('captureBtn').disabled = false;
      document.getElementById('trainBtn').disabled = false;
      document.getElementById('predictBtn').disabled = false;
      log('C√°mara iniciada (fallback)');
    } catch (e2) {
      showToast('No se pudo acceder a ninguna c√°mara.');
    }
  }
};

// Bucle de an√°lisis
async function loopFrame(){
  if(!videoEl.videoWidth)return requestAnimationFrame(loopFrame);
  await hands.send({image:videoEl});
  requestAnimationFrame(loopFrame);
}

// Normalizaci√≥n de coordenadas
function norm(lm){
  const x=lm.map(p=>p.x),y=lm.map(p=>p.y);
  const cx=(Math.min(...x)+Math.max(...x))/2,cy=(Math.min(...y)+Math.max(...y))/2;
  const tmp=[];for(let i=0;i<lm.length;i++){tmp.push(lm[i].x-cx);tmp.push(lm[i].y-cy);}
  const scale=Math.max(1e-6,Math.max(...tmp.map(Math.abs)));
  return tmp.map(v=>v/scale);
}

// Captura la posici√≥n de la mano
function draw(results){
  if(results.multiHandLandmarks && results.multiHandLandmarks.length>0){
    lastVector = norm(results.multiHandLandmarks[0]);
  }
}

// Capturar muestra
captureBtn.onclick=()=>{
  if(!lastVector){showToast('No hay mano detectada');return;}
  const lbl=prompt('Etiqueta para esta se√±a (ej: A, B, Hola):');
  if(!lbl)return;
  samples.push(lastVector);labels.push(lbl);
  log(`Capturada muestra (${lbl})`);
  showToast('Muestra guardada');
};

// Entrenar modelo
trainBtn.onclick=async()=>{
  if(samples.length<2){showToast('Necesitas m√°s muestras');return;}
  const lbls=[...new Set(labels)],Y=labels.map(l=>lbls.indexOf(l));
  const X=tf.tensor2d(samples),y=tf.oneHot(tf.tensor1d(Y,'int32'),lbls.length);
  model=tf.sequential();
  model.add(tf.layers.dense({units:64,activation:'relu',inputShape:[X.shape[1]]}));
  model.add(tf.layers.dense({units:32,activation:'relu'}));
  model.add(tf.layers.dense({units:lbls.length,activation:'softmax'}));
  model.compile({optimizer:'adam',loss:'categoricalCrossentropy',metrics:['acc']});
  showToast('Entrenando...');
  await model.fit(X,y,{epochs:30,callbacks:{onEpochEnd:(e,l)=>{progress.innerHTML=`√âpoca ${e+1}/30 - Precisi√≥n: ${(l.acc*100).toFixed(1)}%`;}}});
  showToast('Entrenamiento finalizado');
  log('Modelo listo ‚úÖ');
  document.getElementById('saveModelBtn').disabled=false;
};

// Predicci√≥n en tiempo real
predictBtn.onclick=()=>{
  if(!model){showToast('Primero entrena o carga un modelo');return;}
  showToast('Predicci√≥n iniciada');
  loopPred();
};
function loopPred(){
  if(lastVector && model){
    const p=model.predict(tf.tensor2d([Array.from(lastVector)])).arraySync()[0];
    const lbl=[...new Set(labels)][p.indexOf(Math.max(...p))];
    progress.innerHTML=`Predicci√≥n: <b>${lbl}</b>`;
  }
  requestAnimationFrame(loopPred);
}

// Guardar / Cargar modelo
saveModelBtn.onclick=async()=>{
  if(model){await model.save('indexeddb://lsc-model');showToast('Modelo guardado');}
};
loadModelBtn.onclick=async()=>{
  try{
    model=await tf.loadLayersModel('indexeddb://lsc-model');
    showToast('Modelo cargado');
    document.getElementById('predictBtn').disabled=false;
  }catch(e){showToast('No hay modelo guardado');}
};

// Exportar / importar dataset
exportDataBtn.onclick=()=>{
  const blob=new Blob([JSON.stringify({samples,labels})],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='dataset.json';a.click();
};
importDataBtn.onclick=()=>importDataInput.click();
importDataInput.onchange=e=>{
  const file=e.target.files[0];
  if(file){
    const r=new FileReader();
    r.onload=()=>{
      const d=JSON.parse(r.result);
      samples=d.samples;labels=d.labels;
      showToast('Dataset importado');
      log('Dataset cargado');
    };
    r.readAsText(file);
  }
};
</script>
</body>
</html>
